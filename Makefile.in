KRB5=@KRB5@
KRBAFS=@KRBAFS@
DEFS=@DEFS@
SHLIBDEP=@SHLIBDEP@
TARGET=@TARGET@

# shamelessly stolen from the usermode makefile
VERSION=$(shell awk '/^Version:/ { print $$2 }' < pam_krb5.spec)
REVISION=$(shell awk '/^Revision:/ { print $$2 }' < pam_krb5.spec)
CVSTAG = pk$(subst .,-,$(VERSION))$(subst .,-,$(REVISION))

CC=@CC@
CFLAGS=-Wall -Wshadow -Wcast-align @CFLAGS@ $(DEFS)
LDFLAGS=@LDFLAGS@ @LIBS@
CCSHLIBFLAGS=-Wl,-rpath=$(KRB5)/lib -Wl,-rpath=$(KRBAFS) $(LDFLAGS)
LDSHLIBFLAGS=-R$(KRB5)/lib -R$(KRBAFS) $(LDFLAGS)

modules: $(TARGET).o $(SHLIBDEP)

$(TARGET).so: $(SHLIBDEP)

$(TARGET).o: pam_krb5afs.c
	$(CC) $(CFLAGS) -c -o $@ $^

SunOS: $(TARGET).o
	/usr/ccs/bin/ld -G -o $(TARGET).so $^ $(LDSHLIBFLAGS)

Linux: $(TARGET).o
	$(CC) -shared -o $(TARGET).so $^ $(CCSHLIBFLAGS)

all: dlopen kreset

install: $(SHLIBDEP) $(DESTDIR)/lib/security/$(TARGET).so install-man

install-man:
	test -d $(DESTDIR)/usr/man/man5 || mkdir -p $(DESTDIR)/usr/man/man5
	@INSTALL@ -m 644 $(TARGET).5 $(DESTDIR)/usr/man/man5
	test -d $(DESTDIR)/usr/man/man8 || mkdir -p $(DESTDIR)/usr/man/man8
	@INSTALL@ -m 644 $(TARGET).8 $(DESTDIR)/usr/man/man8

$(DESTDIR)/lib/security/$(TARGET).so: $(TARGET).so
	test -d $(DESTDIR)/lib/security || mkdir -p $(DESTDIR)/lib/security
	@INSTALL@ -m 755 $(TARGET).so $(DESTDIR)/lib/security

clean:
	$(RM) *.so *.o main core krb5 kreset dlopen

distclean: clean
	$(RM) Makefile config.cache config.log config.status config.h
	$(RM) ltconfig ltmain.sh pam.d

kreset: kreset.c
	$(CC) -o $@ $(CFLAGS) $^ $(LDFLAGS)

dlopen: dlopen.c
	$(CC) -o $@ $^ -lpam -ldl
	
test: dlopen $(SHLIBDEP)
	./dlopen ./$(TARGET).so

pam_krb5afs.c: config.h

dist: archive
archive:
	cvs tag -F $(CVSTAG) .
	@rm -rf /tmp/$(TARGET)-$(VERSION) /tmp/$(TARGET)
	@cd /tmp; cvs export -r$(CVSTAG) pam_krb5
	@( cd /tmp/pam_krb5 ; autoheader ; autoconf )
	@mv /tmp/pam_krb5 /tmp/$(TARGET)-$(VERSION)
	@dir=$$PWD; cd /tmp; tar cvzf $$dir/$(TARGET)-$(VERSION).tar.gz $(TARGET)-$(VERSION)
	@rm -rf /tmp/$(TARGET)-$(VERSION)
	@echo "The archive is in $(TARGET)-$(VERSION).tar.gz"

