# shamelessly stolen from the usermode makefile
VERSION=$(shell awk '/^Version:/ { print $$NF }' pam_krb5.spec)
REVISION=$(shell awk '/^Release:/ { print $$NF }' pam_krb5.spec)
CVSTAG = pk$(subst .,-,$(VERSION))-$(subst .,-,$(REVISION))

KRB5=@KRB5@
KRBAFS=@KRBAFS@
DEFS=@DEFS@
OS=@OS@

prefix=@prefix@
exec_prefix=@exec_prefix@

CC=@CC@
FLEX=@FLEX@
YACC=@YACC@
#CFLAGS=-Wall -Wshadow -Wcast-align @CFLAGS@ $(DEFS)
CFLAGS=-Wcast-align @CFLAGS@ $(DEFS)
LDFLAGS=@LDFLAGS@ @LIBS@
KRB5LIBS=@KRB5LIBS@
KRB5AFSLIBS=@KRB5AFSLIBS@
CCSHLIBFLAGS=$(LDFLAGS)
LDSHLIBFLAGS=$(LDFLAGS)
MODULEDIR=@moduledir@
MODULES = pam_krb5.so pam_krb5afs.so
MAN5TARGETS = @MAN5TARGETS@
MAN8TARGETS = @MAN8TARGETS@
mandir=/usr/share/man

all: krb5conf modules check

modules: $(MODULES)

pam_krb5.o: pam_krb5afs.c krb5conf.l.c config.h
	$(CC) $(CFLAGS) -c -o $@ pam_krb5afs.c

pam_krb5afs.o: pam_krb5afs.c krb5conf.l.c config.h
	$(CC) $(CFLAGS) -DAFS -c -o $@ pam_krb5afs.c

ifeq ($(OS),Linux)
pam_krb5.so: pam_krb5.o Versions
	$(CC) -shared -o pam_krb5.so pam_krb5.o $(KRB5LIBS) $(CCSHLIBFLAGS) -Wl,--version-script=Versions

pam_krb5afs.so: pam_krb5afs.o Versions
	$(CC) -shared -o pam_krb5afs.so pam_krb5afs.o $(KRB5AFSLIBS) $(CCSHLIBFLAGS) -Wl,--version-script=Versions
endif

ifeq ($(OS),SunOS)
pam_krb5.so: pam_krb5.o
	/usr/ccs/bin/ld -G -o pam_krb5.so $^ $(KRB5LIBS) $(LDSHLIBFLAGS) flock.o -lpam -ldyn

pam_krb5afs.so: pam_krb5afs.o
	/usr/ccs/bin/ld -G -o pam_krb5afs.so $^ $(KRB5AFSLIBS) $(LDSHLIBFLAGS) flock.o -lpam -ldyn
endif

install: $(SHLIBDEP) install-modules install-man

install-modules:
	test -d $(DESTDIR)/$(MODULEDIR) || mkdir -p $(DESTDIR)/$(MODULEDIR)
	@INSTALL@ -m 755 $(MODULES) $(DESTDIR)/$(MODULEDIR)

install-man:
	test -d $(DESTDIR)$(mandir)/man5 || mkdir -p $(DESTDIR)$(mandir)/man5
	@INSTALL@ -m 644 $(MAN5TARGETS) $(DESTDIR)$(mandir)/man5
	test -d $(DESTDIR)$(mandir)/man8 || mkdir -p $(DESTDIR)$(mandir)/man8
	@INSTALL@ -m 644 $(MAN8TARGETS) $(DESTDIR)$(mandir)/man8

clean:
	$(RM) *.so *.o krb5conf.l.c krb5conf.y.c y.tab.c y.tab.h main core krb5 kreset dlopen

distclean: clean
	$(RM) Makefile config.cache config.log config.status config.h
	$(RM) ltconfig ltmain.sh

check: dlopen
	./dlopen $(MODULES)

y.tab.c: krb5conf.y
	$(YACC) -pxkrb5_conf_ krb5conf.y

krb5conf.l.c: krb5conf.l
	$(FLEX) -Pxkrb5_conf_ -okrb5conf.l.c krb5conf.l

krb5conf: krb5conf.l.c y.tab.c
	$(CC) $(CFLAGS) -o $@ -DKRB5CONF_APP krb5conf.l.c -lfl

pam_krb5afs.c: config.h krb5conf.l.c

kreset: kreset.c
	$(CC) -o $@ $(CFLAGS) $^ $(LDFLAGS)

dlopen: dlopen.c
	$(CC) -o $@ $^ -lpam -ldl

dist: archive

force-tag:
	cvs tag -cF $(CVSTAG) .

tag:
	cvs tag -c $(CVSTAG) .

archive:
	@rm -rf /tmp/pam_krb5-$(VERSION) /tmp/pam_krb5
	@( dir=`pwd`; cd /tmp; cvs -d `cat $$dir/CVS/Root` export -r$(CVSTAG) pam_krb5 )
	@( cd /tmp/pam_krb5 ; autoheader ; autoconf )
	@mv /tmp/pam_krb5 /tmp/pam_krb5-$(VERSION)-$(REVISION)
	@dir=$$PWD; cd /tmp; tar cvzf $$dir/pam_krb5-$(VERSION)-$(REVISION).tar.gz pam_krb5-$(VERSION)-$(REVISION)
	@rm -rf /tmp/pam_krb5-$(VERSION)-$(REVISION)
	@echo "The archive is in pam_krb5-$(VERSION)-$(REVISION).tar.gz"
