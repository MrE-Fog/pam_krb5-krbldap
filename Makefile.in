# shamelessly stolen from the usermode makefile
VERSION=$(shell awk '/^Version:/ { print $$NF }' pam_krb5.spec)
REVISION=$(shell awk '/^Release:/ { print $$NF }' pam_krb5.spec)
CVSTAG = pk$(subst .,-,$(VERSION))-$(subst .,-,$(REVISION))

KRB5=@KRB5@
KRBAFS=@KRBAFS@
DEFS=@DEFS@
OS=@OS@

CC=@CC@
FLEX=@FLEX@
YACC=@YACC@
CFLAGS=-Wall -Wshadow -Wcast-align @CFLAGS@ $(DEFS)
LDFLAGS=@LDFLAGS@ @LIBS@
CCSHLIBFLAGS=-Wl,-rpath=$(KRB5)/lib -Wl,-rpath=$(KRBAFS) $(LDFLAGS)
LDSHLIBFLAGS=-R$(KRB5)/lib -R$(KRBAFS) $(LDFLAGS)
MODULES = pam_krb5.so pam_krb5afs.so
MAN5TARGETS = @MAN5TARGETS@
MAN8TARGETS = @MAN8TARGETS@
mandir=/usr/share/man

all: modules check

modules: $(MODULES)

pam_krb5.o: pam_krb5afs.c krb5conf.l.c
	$(CC) $(CFLAGS) -c -o $@ pam_krb5afs.c

pam_krb5afs.o: pam_krb5afs.c krb5conf.l.c
	$(CC) $(CFLAGS) -DAFS -c -o $@ pam_krb5afs.c

ifeq ($(OS),Linux)
pam_krb5.so: pam_krb5.o Versions
	$(CC) -shared -o pam_krb5.so pam_krb5.o $(CCSHLIBFLAGS) -Wl,--version-script=Versions

pam_krb5afs.so: pam_krb5afs.o Versions
	$(CC) -shared -o pam_krb5afs.so pam_krb5afs.o $(CCSHLIBFLAGS) -Wl,--version-script=Versions
endif

ifeq ($(OS),SunOS)
pam_krb5.so: pam_krb5.o
	/usr/ccs/bin/ld -G -o pam_krb5.so $^ $(LDSHLIBFLAGS) flock.o -lpam -ldyn

pam_krb5afs.so: pam_krb5afs.o
	/usr/ccs/bin/ld -G -o pam_krb5afs.so $^ $(LDSHLIBFLAGS) flock.o -lpam -ldyn
endif

install: $(SHLIBDEP) install-modules install-man

install-modules:
	test -d $(DESTDIR)/lib/security || mkdir -p $(DESTDIR)/lib/security
	@INSTALL@ -m 755 $(MODULES) $(DESTDIR)/lib/security

install-man:
	test -d $(DESTDIR)$(mandir)/man5 || mkdir -p $(DESTDIR)$(mandir)/man5
	@INSTALL@ -m 644 $(MAN5TARGETS) $(DESTDIR)$(mandir)/man5
	test -d $(DESTDIR)$(mandir)/man8 || mkdir -p $(DESTDIR)$(mandir)/man8
	@INSTALL@ -m 644 $(MAN8TARGETS) $(DESTDIR)$(mandir)/man8

clean:
	$(RM) *.so *.o krb5conf.l.c krb5conf.y.c main core krb5 kreset dlopen

distclean: clean
	$(RM) Makefile config.cache config.log config.status config.h
	$(RM) ltconfig ltmain.sh

check: dlopen
	./dlopen $(MODULES)

krb5conf.l.c: krb5conf.l krb5conf.y
	$(FLEX) -Pxkrb5_conf_ -okrb5conf.l.c krb5conf.l
	$(YACC) -pxkrb5_conf_ -okrb5conf.y.c krb5conf.y

pam_krb5afs.c: config.h krb5conf.l.c

kreset: kreset.c
	$(CC) -o $@ $(CFLAGS) $^ $(LDFLAGS)

dlopen: dlopen.c
	$(CC) -o $@ $^ -lpam -ldl

dist: archive
archive:
	cvs tag -cF $(CVSTAG) .
	@rm -rf /tmp/pam_krb5-$(VERSION) /tmp/pam_krb5
	@( cd /tmp; cvs export -r$(CVSTAG) pam_krb5 )
	@( cd /tmp/pam_krb5 ; autoheader ; autoconf )
	@mv /tmp/pam_krb5 /tmp/pam_krb5-$(VERSION)-$(REVISION)
	@dir=$$PWD; cd /tmp; tar cvzf $$dir/pam_krb5-$(VERSION)-$(REVISION).tar.gz pam_krb5-$(VERSION)-$(REVISION)
	@rm -rf /tmp/pam_krb5-$(VERSION)-$(REVISION)
	@echo "The archive is in pam_krb5-$(VERSION)-$(REVISION).tar.gz"
