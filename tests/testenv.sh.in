#!/bin/sh

PATH=${testdir}/tools:${PATH}; export PATH

test_principal=`id -nu`

if test @USE_KRB4@ -eq 1 ; then
	test_krb4=true
else
	test_krb4=false
fi

pam_krb5=@abs_builddir@/../src/pam_krb5.so
if ! test -x $pam_krb5 ; then
	pam_krb5=@abs_builddir@/../src/.libs/pam_krb5.so
fi

krb5kdc=@KRB5KDC@
if test $krb5kdc = : ; then
	krb5kdc=
fi
krb524d=@KRB524D@
if test $krb524d = : ; then
	krb524d=
fi
kadmind=@KADMIND@
if test $kadmind = : ; then
	kadmind=
fi
kadmin=@KADMINLOCAL@
if test $kadmin = : ; then
	kadmin=
fi

KRB5_CONFIG=@abs_builddir@/config/krb5.conf ; export KRB5_CONFIG
KRBCONFDIR=@abs_builddir@/config ; export KRBCONFDIR
KRB_CONF=@abs_builddir@/config/krb.conf ; export KRB_CONF
KRB_REALMS=@abs_builddir@/config/krb.realms ; export KRB_REALMS
KRB5_KDC_PROFILE=@abs_builddir@/config/kdc.conf ; export KRB5_KDC_PROFILE
KRB5RCACHEDIR=@abs_builddir@/kdc ; export KRB5RCACHEDIR
KRB5CCNAME=/dev/bogus-missing-file ; export KRB5CCNAME
KRBTKFILE=/dev/bogus-missing-file ; export KRBTKFILE
test_flags=unsecure_for_debugging_only

test_settle() {
	sleep 2
}

test_cleanmsg ()
{
	sed -e "s,Warning: Your password will expire in less than one hour.[^\']*,WARN1HOUR,g" \
	    -e "s,Warning: .*password has expired[^\']*,WARNEXPIRED,g" \
	    -e "s|$testdir/kdc|"'$testdir/kdc|g' \
	    -e "s|krb5cc_"`id -u`"_......|"'krb5_cc_$UID_XXXXXX|g'
}

test_comparelog() {
	if test -s @abs_builddir@/config/$1.txt ; then
		if cmp @abs_builddir@/config/$1.txt \
			  @abs_builddir@/kdc/$1.log ; then
			diff -u @abs_builddir@/config/$1.txt \
				   @abs_builddir@/kdc/$1.log
			exit 1
		fi
	fi
}

test_k524start() {
	if test x$K524DPID != x ; then
		kill -TERM $K524DPID
		unset K524DPID
	fi

	$krb524d -m -r EXAMPLE.COM -nofork > /dev/null 2> /dev/null &
	K524DPID=$!

	kill -CONT $K524DPID
}

test_kdcinitdb() {
	test -d @abs_builddir@/kdc || mkdir -p @abs_builddir@/kdc
	kdb5_util destroy -f 2> /dev/null > /dev/null
	(echo .; echo .; echo .) | kdb5_util create -s 2> /dev/null > /dev/null

	$kadmin -q 'addpol -minlength 6 minimum_six' 2> /dev/null > /dev/null
	$kadmin -q 'ank -pw foo '$test_principal 2> /dev/null > /dev/null
	$kadmin -q 'modprinc -maxrenewlife "1 day" -maxlife "7 day" krbtgt/EXAMPLE.COM' 2> /dev/null > /dev/null
	$kadmin -q 'modprinc -maxrenewlife "1 day" -maxlife "7 day" '$test_principal 2> /dev/null > /dev/null
}

test_kdcstart() {
	rm -f @abs_builddir@/kdc/krb5kdc.log
	rm -f @abs_builddir@/kdc/kadmind.log
	rm -f @abs_builddir@/kdc/krb5libs.log

	if test x$KDCPID != x ; then
		kill -KILL $KDCPID 2> /dev/null
		unset KDCPID
	fi
	$krb5kdc -r EXAMPLE.COM -n > /dev/null 2> /dev/null &
	KDCPID=$!

	if test x$KADMINDPID != x ; then
		kill -KILL $KADMINDPID 2> /dev/null
		unset KADMINDID
	fi

	$kadmind -r EXAMPLE.COM -nofork > /dev/null 2> /dev/null &
	KADMINDPID=$!

	if $test_krb4 ; then
		test_k524start
	fi

	kill -CONT $KDCPID
	kill -CONT $KADMINDPID
	trap test_kdcstop EXIT
}

test_k524stop() {
	if test x$K524DPID != x ; then
		kill -TERM $K524DPID 2> /dev/null
		unset K524DPID
	else
		echo "echo error: no running krb524d"
		exit 1
	fi
}

test_kdcstop() {
	if $test_krb4 ; then
		test_k524stop
	fi
	if test x$KADMINDPID != x ; then
		kill -TERM $KADMINDPID 2> /dev/null
		unset KADMINDID
	fi
	if test x$KDCPID != x ; then
		kill -TERM $KDCPID 2> /dev/null
		unset KDCPID
	fi
}

test_run() {
	# Filter out the module path and clean up messages.
	@abs_builddir@/tools/pam_harness "$@" 2>&1 | sed s,"\`.*pam",'\`pam',g | test_cleanmsg
}
